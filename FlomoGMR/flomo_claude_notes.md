# Flomo-to-Geno Retargeting Notes

Notes on retargeting Flomo-converted Xsens BVH animations onto the Geno/LAFAN1 skeleton.

## Quick Start

```bash
conda activate gmr

# single file
cd F:\experiments\tests202601\FlomoGMR
python scripts/flomo_to_geno_bvh.py \
  --bvh_file "F:\experiments\tests202601\Flomo\data\timi\xs_20251101_aleblanc_lantern_nav-003.fbx.bvh" \
  --output_bvh output.bvh \
  --skip_tpose

# batch (output goes next to inputs by default: foo.fbx.bvh -> foo.fbx.geno.bvh)
python scripts/flomo_batch_retarget.py \
  --input_dir "F:\experiments\tests202601\Flomo\data\timi" \
  --skip_tpose

# or with a separate output directory:
python scripts/flomo_batch_retarget.py \
  --input_dir "F:\experiments\tests202601\Flomo\data\timi" \
  --output_dir some/output/dir \
  --skip_tpose
```

## Context

Flomo's fbx2bvh converts Xsens FBX mocap files to BVH. These use standard joint names (Hips, LeftUpLeg, LeftFoot, etc.) rather than raw Xsens names (Pelvis, L5, LeftHip, LeftAnkle). Positions are in meters, Y-up, rotation order ZXY, mixed channels (6 root + 3 others). First frame is typically a T-pose.

The Geno skeleton IS the LAFAN1 skeleton (75 bodies / 77 joints including fingers). Its MuJoCo XML was generated by `generate_geno_xml.py` from `Geno_bind.bvh`, with the coordinate mapping BVH(x,y,z) -> MJ(x,-z,y). The rest pose has arms pointing straight up (+Z), not in T-pose — the first frame of Geno_bind.bvh contains non-zero rotations that put the skeleton into T-pose.

## Pipeline Architecture

The retargeting has three stages per frame:

1. **Preset** — Copy leg rotations from source BEFORE IK. This gives the IK solver a good starting point so knees don't bend sideways.

2. **IK solve** — GMR's mink IK solver matches root position/orientation, spine orientation, and foot positions. Configured in `bvh_xsens_to_geno.json` (Hips, Spine3, LeftUpLeg, LeftLeg, RightUpLeg, RightLeg, LeftFoot, RightFoot).

3. **Override** — Copy arm, head, and foot rotations from source AFTER IK, completely replacing the solver's output. These joints are better served by direct copy because IK only needs to handle root/spine/feet.

Both preset and override stages apply **twist offsets** (see below).

## Twist Offsets (the hard part)

When copying a local rotation from source to Geno, the body gets the correct world ORIENTATION but the bone DIRECTION (joint-to-child vector) can be wrong because the child offset vectors differ between skeletons.

Example: Geno's LeftArm→LeftForeArm offset points along +Z (up). The source T-pose has it horizontal. Copying identity rotation from T-pose → arm points up. ~90° error.

### The fix

For each override joint, compute a rotation `R_twist` that maps the Geno rest-pose bone direction to the source T-pose bone direction:

```
d_geno   = normalize(geno_rest_pos[child] - geno_rest_pos[joint])
d_target = inv(source_world_rot[joint]) * normalize(source_tpose_pos[child] - source_tpose_pos[joint])
R_twist  = align_vectors(d_target, d_geno)
```

### Per-frame application (chain-correct)

```
q_corrected = inv(R_twist_parent) * q_source_local * R_twist_self
```

The `inv(R_twist_parent)` compensates for the parent's twist so it doesn't accumulate. After correction: `world_rot_J_geno = world_rot_J_src * R_twist_J`, which gives the correct bone direction in world space.

### Computed twist values

| Joint | Twist (deg) | Why |
|-------|-------------|-----|
| LeftShoulder | 90.0 | arm bones point +Z in rest, horizontal in T-pose |
| LeftArm | 88.9 | same |
| LeftForeArm | 87.4 | same |
| LeftHand | 100.4 | uses MiddleFinger1 as Geno ref, forearm→hand as source proxy |
| RightShoulder | 90.0 | symmetric with left |
| RightArm | 90.2 | |
| RightForeArm | 90.7 | |
| RightHand | 118.8 | asymmetry from imperfect source T-pose |
| Neck | 0.1 | both skeletons point up, nearly no correction |
| Head | 0.0 | leaf joint, no bone to align |
| LeftFoot | 23.9 | Geno foot-to-toe is angled down ~24° from horizontal |
| RightFoot | 23.9 | symmetric |

### Special case: hands

The source has no finger joints, so we can't compute a hand→finger bone direction. Instead we use `LeftHandMiddle1` as the Geno reference direction and `LeftForeArm→LeftHand` as the source direction proxy (in T-pose the palm extends in the same direction as the forearm).

## Coordinate System Bugs We Fixed

### 1. Euler convention (flomo_bvh.py)

BVHParser's `euler_to_quat` uses extrinsic "xyz" regardless of BVH channel order — wrong for ZXY files. After the axis_order="zxy" remap (MJ_X=BVH_Z, MJ_Y=BVH_X, MJ_Z=BVH_Y), the BVH intrinsic ZXY becomes intrinsic XYZ in MJ frame. We bypass BVHParser's conversion:

```python
rot_reordered = np.stack([rotations[..., 2], rotations[..., 0], rotations[..., 1]], axis=-1)
quats = Rot.from_euler('XYZ', rot_reordered.reshape(-1, 3), degrees=True).as_quat(scalar_first=True)
```

### 2. Yaw mismatch (flomo_bvh.py)

BVHParser "zxy" produces MJ=(bvh_z, bvh_x, bvh_y), so MJ X=forward. But geno.xml has MJ=(bvh_x, -bvh_z, bvh_y), so MJ X=lateral. These differ by Rz(-90°). Fixed with:

- Positions: matrix multiply by Rz(-90°)
- Orientations: **conjugation** `R * Q * R_inv` (NOT left-multiply `R * Q` — that would add a spurious rotation instead of changing coordinate frames. Conjugation preserves identity→identity.)

### 3. qpos-to-BVH coordinate transform (flomo_to_geno_bvh.py)

To reverse generate_geno_xml.py's mapping: MJ(x,y,z) → BVH(x, z, -y), then ×100 for cm. For quaternions, the imaginary part (rotation axis) transforms the same way: MJ quat (w, vx, vy, vz) → BVH quat (w, vx, vz, -vy). Euler decomposition uses intrinsic ZYX (uppercase in scipy).

## Files

### New files

| File | Purpose |
|------|---------|
| `general_motion_retargeting/utils/flomo_bvh.py` | BVH loader for Flomo-converted Xsens files |
| `scripts/flomo_to_geno_bvh.py` | Single-file retargeting script |
| `scripts/flomo_batch_retarget.py` | Batch retargeting script |

### Modified files

| File | Change |
|------|--------|
| `general_motion_retargeting/params.py` | Added `bvh_flomo` source format |
| `general_motion_retargeting/ik_configs/bvh_xsens_to_geno.json` | Stripped to IK-only joints (arms/head removed, handled by override) |

### Key reference files

| File | What |
|------|------|
| `assets/geno/geno.xml` | MuJoCo XML for Geno/LAFAN1 skeleton |
| `generate_geno_xml.py` | How geno.xml was generated (defines the coord mapping) |
| `general_motion_retargeting/ik_configs/bvh_xsens_to_geno.json` | IK config: Hips, Spine3, legs, feet |

### Test artifacts (in flomotests/)

Old intermediate outputs from debugging, kept for reference:
- `output_variant_*.bvh` — different qpos→euler conversion attempts
- `output_yawfix.bvh` — after yaw fix but before euler fix
- `output_conjugation.bvh` — after conjugation fix
- `output_twist.bvh` — final working output with twist offsets

## Environment

```bash
conda activate gmr
# if moved to a new directory, reinstall:
cd F:\experiments\tests202601\FlomoGMR
pip install -e .
pip install daqp  # if not already installed
```

Python: `C:\Users\LocalUser\miniconda3\envs\gmr\python.exe`

## IK Config (bvh_xsens_to_geno.json)

Only these joints go through IK. Everything else is either preset (legs) or override (arms/head/feet):

```
Hips:       position weight=0,   rotation weight=10
Spine3:     position weight=0,   rotation weight=10
LeftUpLeg:  position weight=0,   rotation weight=20
LeftLeg:    position weight=0,   rotation weight=20
RightUpLeg: position weight=0,   rotation weight=20
RightLeg:   position weight=0,   rotation weight=20
LeftFoot:   position weight=50,  rotation weight=10
RightFoot:  position weight=50,  rotation weight=10
```

The second pass (ik_match_table2) bumps Hips position weight to 100 and Spine3 position to 10.
